# Проект по разработке распределенных приложений - Продажа ЖД билетов

[![codecov](https://codecov.io/gh/E6L1PS/train-ticket-sales-app/graph/badge.svg?token=J9MGYJKFPQ)](https://codecov.io/gh/E6L1PS/train-ticket-sales-app)

## Используемые технологии:

- Java в качестве основного языка программирования
- Spring Boot для rest-api приложения
- lombok для сокращения кода в классах и расширения функциональности языка Java
- mapstruct помогает маппить объекты одних сущностей в объекты других сущностей
- junit для тестирования
- testcontainers для интеграционного тестирования
- rest-assured для тестирования rest api
- javascript для скриптов в mongodb
- mongodb как основное хранилище данных
- elasticsearch для полнотекстового поиска
- redis в качестве кэширования и блокирования
- docker для виртуализации
- docker-compose для оркестрации и запуска кластера
- nginx в качестве балансировщика нагрузки

## Основные сущности:

- Остановочный пункт (Station) - справочник станций, которые могут быть пунктом отправления или назначения в билете (
  Москва, Бологое, Санкт-Петербург)
- Маршрут (Route) - множество станций, на которых останавливается поезд (маршрут #251: Москва, Тверь, Вышний Волочек,
  Бологое, Санкт-Петербург)
- Поезд (Train) - поезд, назначенный на указанные маршрут на конкретную дату (рейс поезда следует, назначенный на
  25.09.2017 следует по маршруту #251)
- Билет (TicketPlace) - место в поезде, свободное или купленное.

![ERD](src/main/resources/ERD.svg)

## Задача:

Требуется реализовать прототип распределенной системы для продажи железнодорожных билетов для одной из наиболее развитых
железнодорожных сетей мира. Система должна обеспечивать устойчивость к обрывам связи при стабильной гарантированной
производительности.
Для хранения данных предлагается использовать кластер MongoDB с шардингом и репликацией.
Для поиска поездов и доступных билетов - ElasticSearch
Для кэширования справочников (станций) - кэш Redis
Для блокирования места при бронировании и до получения оплаты - механизм блокировок в Redis

## Сценарии:

* Инициализация поездов
    1. Заполнение данными Station, Route
    2. Заполнение данными Train и TicketPlace (порядка миллионов документов в TicketPlace)
* Поиск свободных мест и покупка билета
    1. Пользователь вводит станции отправления и назначения, дату отправления
    2. Система определяет подходящие по станциям маршруты и ищет поезда, следующие по этим маршрутам, отображая только
       те, на которых есть свободные места
    3. Пользователь выбирает поезд, система отображает свободные места
    4. Пользователь выбирает свободное место и нажимает "Купить билет"
    5. Система блокирует указанное место до символической "велиоплаты"
    6. Пользователь оплачивает билет
    7. Система помечает билет как купленные и снимает блокировку

## Архитектура кластера:

![architecture.svg](src/main/resources/architecture.svg)

## Сценарии отказов узлов кластера

| Действие                                                                                                                  | Результат | Почему                                                                                             |
|---------------------------------------------------------------------------------------------------------------------------|-----------|----------------------------------------------------------------------------------------------------|
| Отключение<br/> redis-node-1 or<br/> redis-node-2 or<br/> redis-node-3                                                    | ok        | Есть реплика на<br/> redis-node-4,<br/> redis-node-5,<br/> redis-node-6                            |
| Отключение<br/> redis-node-1 and redis-node-4 or<br/> redis-node-2 and redis-node-5 or<br/> redis-node-3 and redis-node-6 | fail      | Невозможность подключения<br/> к сегменту кэша, в котором<br/> мастер и его реплика вышли из строя |
| Отключение<br/> mongodb-node-1 nand<br/> mongodb-node-2 nand<br/> mongodb-node-3                                          | ok        | При отключении primary узла,<br/> один из secondary узлов становится primary                       |
| Отключение<br/> mongodb-node-1 and<br/> mongodb-node-2 and<br/> mongodb-node-3                                            | fail      | Невозможность подключения к primary узлу,<br/> так как все узлы вышли из строя                     |
| Отключение<br/> elasticsearch-node-1 nand<br/> elasticsearch-node-2 nand<br/> elasticsearch-node-3                        | ok        | При отключении к мастер ноду,<br/> одна из реплик становится мастером                              |
| Отключение<br/> elasticsearch-node-1 and<br/> elasticsearch-node-2 and<br/> elasticsearch-node-3                          | fail      | Невозможность подключения к мастер ноду,<br/> так как все ноды вышли из строя                      |